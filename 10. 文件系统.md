### 文件接口

##### 概念

<font color=red>主要分为数据和程序</font>

##### 打开文件

 进程的打开文件表

 系统的打开文件表

<img src="md_image\image-20220603202506449.png" alt="image-20220603202506449" style="zoom:67%;" />

1. 文件指针 • 文件最后读/写位置指针 • 每个进程打开的文件个数、指针 
2. 文件打开计数器 • 一个文件被打开的次数，当文件关闭时，操作系统必须重设打 开文件表的条目 
3. 文件磁盘位置 • 用于定位磁盘上文件位置信息保存在内存中 
4. 访问权限 • 确定打开文件模式，以便操作系统允许或拒绝以后的I/O请求

##### 加锁



#### 文件访问

##### 顺序

##### 直接

相对块号直接对应物理块号，通过物理块号直接访问

##### 索引

首先搜索索引，再根据指针直接访问文件

#### 目录结构

##### 单层次目录

##### 双层次目录：主文件目录+用户文件目录

##### 树状结构目录：目录可以包含文件和子目录

<font color=red>树状结构禁止共享文件和目录</font>

##### 无环图目录

###### 符号链接：创建一个称为链接的新目录条目，这个链接指向另一个目录或文件

###### 非符号链接：重复所有被共享文件的信息

如何确保无环？ 

1，不允许链接子目录

2，垃圾收集

3，建立链接前算法检测是否成环

##### 通用图目录：允许有环

删除文件需要确认引用计数，引用计数为0才能删除

#### 文件系统安装：需要设备名称和文件系统安装位置

#### 文件共享

本地文件共享：增加了文件/目录的拥有者、组

远程文件系统：系统之间的文件系统的相互访问；包括FTP、分布式文件系统、浏览器

增加了<font color=red>新的故障模式(因为远程的故障模式和本地故障模式不同)</font>：增加了每个远程请求的<font color=red>状态信息</font>。

例如：<font color=red>NFS...</font>

### 文件系统

#### 结构

<img src="md_image\image-20220606171239180.png" alt="image-20220606171239180" style="zoom:67%;" />

逻文、文组、基文、I

磁盘特点：原地重写，可以访问任意一块

文件系统：存储文件，访问文件机制；

设计问题：存储问题，访问问题

#### FCB（Linux中称为i-node）

文件控制块：权限、日期、大小、拥有者、指针

#### 实现

文件系统包括的信息有 **1. 如何启动操作系统 2. 总的块数  3. 空闲块的数目和位置  4. 目录结构 5. 各个具体文件**

##### 引导控制块：如何启动操作系统

##### 卷控制块：分区的块数、块的大小、空闲块的数量和指针、空闲 FCB 的数量和指针

##### 两张表： 单个进程打开文件表、 系统的打开文件表

<font color=red>Open() 返回值是文件描述符，这是一个非负整数。它是进程打开文件表的索引值，指向系统范围内打开文件表相应条目</font>

##### 虚拟文件系统

把文件系统的**通用操作**和**具体实现**分开；

能区分不同文件系统，能区分本地文件系统和远程文件系统

#### 文件目录实现

##### 线性列表：简单但费时

##### 哈希表

#### <font color=red>磁盘空间分配</font>

##### 连续分配

文件用文件第一块的磁盘地址和连续块的数量（即长度）

**问题（考）**：当文件需要扩展，文件大小变大时会无法扩展

sol：找一个更大的孔复制进去

###### 变种：扩展连续分配（严格意义上来说不算连续分配）

文件格式：【开始地址，块数，指向下一个扩展块的指针】

##### 链接分配

文件格式：【起始块，结束块】；完全不需要连续。

每个磁盘块都有指向下一个磁盘块的地址，从起始块开始读，一直读到结束块。

缺点： I. 不支持文件的直接访问 II. 需要更多的磁盘空间（放指针）

###### 变种：FAT(文件分配表)

每个卷的开始部分用于存储文件分配表； 针对每个磁盘物理块都有一个FAT条目

改善：把FAT表事先放到内存中

##### 索引分配

文件用索引块来定义， 每个文件有其索引块，索引块是一个磁盘块地址的数组

<img src="md_image\image-20220609010523555.png" alt="image-20220609010523555" style="zoom:67%;" />

#### 文件系统的效率和性能

##### 效率

**取决于**：磁盘分配、目录管理算法、在文件目录条目中的数据类型

**如何改善？**

缓存

><font color=red>板载高速缓存</font>
>
><font color=red>页缓存：把文件作为页来缓存，缓存文件的逻辑内容；加速对文件内容的访问</font>
>
><font color=red>缓冲缓存：一块独立内存，位于其中的块是马上需要使用的；加速对磁盘的访问</font>

<img src="md_image\image-20220608231606334.png" alt="image-20220608231606334" style="zoom:67%;" /><img src="md_image\image-20220608231619517.png" alt="image-20220608231619517" style="zoom:67%;" />

<img src="md_image\image-20220608231606334.png" alt="image-20220608231606334" style="zoom:67%;" /><img src="md_image\image-20220608231619517.png" alt="image-20220608231619517" style="zoom:67%;" />

##### 页面置换

文件的读入或写出一般是按顺序进行。所以，不适合采用LRU算法

优化措施：<font color=red>马上释放和预先读取</font>

#### 文件系统恢复

###### 一致性检查

比较<font color=red>目录结构的数据和磁盘中的数据</font>，尝试着去修正不一致

文件创建涉及到**目录结构修改、fcb分配、数据块分配**

元数据（meta data）的变化写入日志上就可以认为：<font color=red>提交事务</font>